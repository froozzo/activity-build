<script>
    async function start() {
        const loadingText = document.createElement("p");
        loadingText.textContent = "Autenticando con Discord...";
        loadingText.style.position = "absolute";
        loadingText.style.top = "50%";
        loadingText.style.left = "50%";
        loadingText.style.transform = "translate(-50%, -50%)";
        loadingText.style.color = "white";
        loadingText.style.fontSize = "24px";
        document.body.appendChild(loadingText);

        console.log("[SDK] Cargando Discord SDK...");

        try {
            const { discordSdk } = window;
            console.log("[SDK] Objeto discordSdk:", discordSdk);

            await discordSdk.ready();
            console.log("[SDK] SDK listo!");

            const appId = "TU_APP_ID_AQUI";
            console.log("[SDK] Autorizando appId:", appId);

            const auth = await discordSdk.commands.authorize({
                client_id: appId,
                response_type: "code",
                state: "lol",
                scope: ["identify"]
            });

            console.log("[SDK] Resultado authorize:", auth);

            if (!auth.code) {
                console.error("[SDK] No devolvió code!");
                loadingText.textContent = "Error: Discord no devolvió autorización.";
                return;
            }

            loadingText.textContent = "Enviando token a Supabase...";

            const backendRes = await fetch(
                "https://mjk...supabase.co/functions/v1/auth-discord",
                {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ code: auth.code })
                }
            );

            console.log("[SDK] Respuesta backend:", backendRes);

            if (!backendRes.ok) {
                loadingText.textContent = "Error validando token en backend.";
                return;
            }

            const backendData = await backendRes.json();
            console.log("[SDK] Backend JSON:", backendData);

            loadingText.textContent = `Hola ${backendData.user.username}! Cargando el juego...`;

            // Iniciar Godot ahora
            const engine = new Engine({
                canvas: document.getElementById("canvas")
            });

            console.log("[GODOT] Iniciando engine...");
            engine.start();

        } catch (e) {
            console.error("[SDK] ERROR FATAL:", e);
            const errMsg = document.createElement("p");
            errMsg.textContent = "Error con Discord: " + e.message;
            errMsg.style.color = "red";
            errMsg.style.position = "absolute";
            errMsg.style.top = "60%";
            errMsg.style.left = "50%";
            errMsg.style.transform = "translate(-50%, -50%)";
            document.body.appendChild(errMsg);
        }
    }

    start();
</script>


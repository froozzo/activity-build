<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>Discord Activity Wrapper</title>
  <style>
    html, body {
      margin: 0;
      padding: 0;
      width: 100%;
      height: 100%;
      background: black;
      overflow: hidden;
    }

    iframe {
      width: 100%;
      height: 100%;
      border: none;
      display: block;
    }
  </style>
  <script type="module" crossorigin src="/assets/index-AeGCj31n.js"></script>
</head>
<body>

  <!-- Tu script principal (Discord SDK, OAuth, etc.) -->

  <!-- Aqui vive Godot -->
  <iframe id="game-frame" src="./game/index.html"></iframe>

<script>
/* ===========================================================
   1) Funcion que main.js llamara para enviar auth
   =========================================================== */
window.sendAuthToGodot = function (payload) {
    console.log("Wrapper recibio auth de main.js:", payload);

    const frame = document.getElementById("game-frame");

    if (!frame || !frame.contentWindow) {
        console.error("Iframe no listo");
        return;
    }

    // Enviamos la data hacia el iframe donde vive Godot
    frame.contentWindow.postMessage(payload, "*");

    console.log("Enviado por postMessage al iframe");
};


/* ===========================================================
   2) Logging de mensajes que regresen desde el iframe (debug)
   =========================================================== */
window.addEventListener("message", (event) => {
    if (!event.data) return;

    if (event.data.type === "discord-auth") {
        console.log("Wrapper: mensaje desde iframe:", event.data);
    }
});

/* ===========================================================
   3) Enviar contexto de la Activity a Godot
   =========================================================== */
const _frame = document.getElementById("game-frame");
const _url = new URL(window.location.href);
const _params = _url.searchParams;

const _context = {
    instance_id: _params.get("instance_id"),
    guild_id: _params.get("guild_id"),
    channel_id: _params.get("channel_id"),
    frame_id: _params.get("frame_id"),
    platform: _params.get("platform"),
    location_id: _params.get("location_id"),
    launch_id: _params.get("launch_id")
};

console.log("Discord Activity Context:", _context);

const _contextMessage = {
    type: "discord-context",
    payload: _context,
    nonce: `${Date.now()}-${Math.random().toString(16).slice(2)}`
};

let _contextSendAttempts = 0;
let _contextAcked = false;
let _contextIntervalId = null;

const _sendContextToIframe = (reason = "manual") => {
    if (_contextAcked) return;
    if (!_frame || !_frame.contentWindow) {
        console.warn("Iframe not ready for context yet");
        return;
    }
    _contextSendAttempts += 1;
    _frame.contentWindow.postMessage(_contextMessage, "*");
    console.log(`Sent discord-context to iframe (${reason}) attempt #${_contextSendAttempts}`, _contextMessage);
    if (_contextSendAttempts >= 8 && _contextIntervalId) {
        clearInterval(_contextIntervalId);
        _contextIntervalId = null;
    }
};

_frame.addEventListener("load", () => {
    _contextSendAttempts = 0;
    _contextAcked = false;
    _sendContextToIframe("iframe-load");
});

_contextIntervalId = setInterval(() => _sendContextToIframe("retry-interval"), 750);
_sendContextToIframe("initial");
setTimeout(() => _sendContextToIframe("delayed"), 500);

window.addEventListener("message", (event) => {
    if (!event.data) return;
    if (event.data.type === "discord-auth") {
        console.log("Wrapper: mensaje desde iframe:", event.data);
    }
    if (event.data.type === "discord-context-ack" && event.data.nonce === _contextMessage.nonce) {
        _contextAcked = true;
        if (_contextIntervalId) {
            clearInterval(_contextIntervalId);
            _contextIntervalId = null;
        }
        console.log("Godot acknowledged receipt of discord-context");
    }
});
</script>

</body>
</html>
